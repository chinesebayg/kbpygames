{% extends "base.html" %}

{% block title %}RPG战斗模拟器{% endblock %}

{% block content %}
<div class="game-container">
    <h1 class="game-title">
        <i class="fas fa-sword"></i> RPG战斗模拟器
    </h1>
    
    <!-- 角色创建区域 -->
    <div id="character-creation" class="row">
        <div class="col-md-6">
            <h3><i class="fas fa-user-plus"></i> 玩家1</h3>
            <div class="mb-3">
                <input type="text" id="player1-name" class="form-control" placeholder="输入角色名字">
            </div>
            <div class="mb-3">
                <select id="player1-class" class="form-select">
                    <option value="">选择职业</option>
                    <option value="warrior">战士 (高HP，中等伤害)</option>
                    <option value="mage">法师 (低HP，高伤害)</option>
                </select>
            </div>
            <button id="create-player1" class="btn btn-primary">
                <i class="fas fa-plus"></i> 创建角色
            </button>
        </div>
        
        <div class="col-md-6">
            <h3><i class="fas fa-user-plus"></i> 玩家2</h3>
            <div class="mb-3">
                <input type="text" id="player2-name" class="form-control" placeholder="输入角色名字">
            </div>
            <div class="mb-3">
                <select id="player2-class" class="form-select">
                    <option value="">选择职业</option>
                    <option value="warrior">战士 (高HP，中等伤害)</option>
                    <option value="mage">法师 (低HP，高伤害)</option>
                </select>
            </div>
            <button id="create-player2" class="btn btn-primary">
                <i class="fas fa-plus"></i> 创建角色
            </button>
        </div>
    </div>
    
    <!-- 角色显示区域 -->
    <div id="characters-display" class="row" style="display: none;">
        <div class="col-md-6">
            <div id="player1-card" class="character-card">
                <h4 id="player1-name-display"></h4>
                <div class="hp-bar">
                    <div id="player1-hp" class="hp-fill" style="width: 100%;"></div>
                </div>
                <p id="player1-info"></p>
            </div>
        </div>
        <div class="col-md-6">
            <div id="player2-card" class="character-card">
                <h4 id="player2-name-display"></h4>
                <div class="hp-bar">
                    <div id="player2-hp" class="hp-fill" style="width: 100%;"></div>
                </div>
                <p id="player2-info"></p>
            </div>
        </div>
    </div>
    
    <!-- 战斗控制区域 -->
    <div id="battle-controls" class="text-center mt-4" style="display: none;">
        <button id="start-battle" class="btn btn-danger btn-lg">
            <i class="fas fa-fire"></i> 开始战斗！
        </button>
        <button id="reset-game" class="btn btn-secondary btn-lg ms-3">
            <i class="fas fa-refresh"></i> 重新开始
        </button>
    </div>
    
    <!-- 战斗日志 -->
    <div id="battle-log" class="battle-log" style="display: none;">
        <h4><i class="fas fa-scroll"></i> 战斗日志</h4>
        <div id="log-content"></div>
    </div>
    
    <!-- 游戏结束 -->
    <div id="game-over" class="text-center mt-4" style="display: none;">
        <div class="alert alert-success">
            <h2 id="winner-message"></h2>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let characters = {};
let battleRound = 0;

// 创建角色
async function createCharacter(playerNum) {
    const name = document.getElementById(`player${playerNum}-name`).value;
    const charClass = document.getElementById(`player${playerNum}-class`).value;
    
    if (!name || !charClass) {
        alert('请输入角色名字并选择职业！');
        return;
    }
    
    try {
        const response = await fetch('/api/rpg/create_character', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                class: charClass
            })
        });
        
        const character = await response.json();
        characters[character.name] = character;
        
        // 更新显示
        updateCharacterDisplay(playerNum, character);
        
        // 检查是否可以开始战斗
        if (Object.keys(characters).length === 2) {
            document.getElementById('characters-display').style.display = 'block';
            document.getElementById('battle-controls').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('创建角色失败！');
    }
}

// 更新角色显示
function updateCharacterDisplay(playerNum, character) {
    const nameDisplay = document.getElementById(`player${playerNum}-name-display`);
    const hpBar = document.getElementById(`player${playerNum}-hp`);
    const info = document.getElementById(`player${playerNum}-info`);
    
    nameDisplay.textContent = `${character.name} (${character.character_class})`;
    const hpPercentage = (character.hp / character.max_hp) * 100;
    hpBar.style.width = `${hpPercentage}%`;
    
    if (hpPercentage < 30) {
        hpBar.classList.add('low');
    } else {
        hpBar.classList.remove('low');
    }
    
    info.innerHTML = `
        HP: ${character.hp}/${character.max_hp}<br>
        状态: ${character.is_alive ? '存活' : '死亡'}
    `;
}

// 开始战斗
async function startBattle() {
    const characterNames = Object.keys(characters);
    if (characterNames.length !== 2) {
        alert('需要创建两个角色才能开始战斗！');
        return;
    }
    
    document.getElementById('battle-log').style.display = 'block';
    document.getElementById('start-battle').disabled = true;
    
    battleRound = 0;
    await battleLoop();
}

// 战斗循环
async function battleLoop() {
    const characterNames = Object.keys(characters);
    const player1 = characters[characterNames[0]];
    const player2 = characters[characterNames[1]];
    
    if (!player1.is_alive || !player2.is_alive) {
        endGame();
        return;
    }
    
    battleRound++;
    addToLog(`<strong>第 ${battleRound} 回合</strong>`);
    
    try {
        const response = await fetch('/api/rpg/battle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player1: characterNames[0],
                player2: characterNames[1]
            })
        });
        
        const result = await response.json();
        
        // 更新角色状态
        characters[characterNames[0]] = result.player1;
        characters[characterNames[1]] = result.player2;
        
        // 显示战斗日志
        result.battle_log.forEach(log => {
            addToLog(log);
        });
        
        // 更新显示
        updateCharacterDisplay(1, result.player1);
        updateCharacterDisplay(2, result.player2);
        
        // 检查游戏是否结束
        if (result.winner) {
            endGame(result.winner);
        } else {
            // 继续下一回合
            setTimeout(battleLoop, 1000);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('战斗失败！');
    }
}

// 结束游戏
function endGame(winner = null) {
    if (winner) {
        document.getElementById('winner-message').textContent = `🏆 战斗结束！${winner} 获胜！`;
    } else {
        document.getElementById('winner-message').textContent = '🏆 战斗结束！';
    }
    document.getElementById('game-over').style.display = 'block';
}

// 重新开始游戏
function resetGame() {
    characters = {};
    battleRound = 0;
    
    // 重置表单
    document.getElementById('player1-name').value = '';
    document.getElementById('player1-class').value = '';
    document.getElementById('player2-name').value = '';
    document.getElementById('player2-class').value = '';
    
    // 隐藏元素
    document.getElementById('characters-display').style.display = 'none';
    document.getElementById('battle-controls').style.display = 'none';
    document.getElementById('battle-log').style.display = 'none';
    document.getElementById('game-over').style.display = 'none';
    
    // 重置按钮
    document.getElementById('start-battle').disabled = false;
    
    // 清空日志
    document.getElementById('log-content').innerHTML = '';
}

// 添加日志
function addToLog(message) {
    const logContent = document.getElementById('log-content');
    logContent.innerHTML += `<div class="mb-2">${message}</div>`;
    logContent.scrollTop = logContent.scrollHeight;
}

// 事件监听器
document.getElementById('create-player1').addEventListener('click', () => createCharacter(1));
document.getElementById('create-player2').addEventListener('click', () => createCharacter(2));
document.getElementById('start-battle').addEventListener('click', startBattle);
document.getElementById('reset-game').addEventListener('click', resetGame);
</script>
{% endblock %}

