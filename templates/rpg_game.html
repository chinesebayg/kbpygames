{% extends "base.html" %}

{% block title %}RPGæˆ˜æ–—æ¨¡æ‹Ÿå™¨{% endblock %}

{% block content %}
<div class="game-container">
    <h1 class="game-title">
        <i class="fas fa-sword"></i> RPGæˆ˜æ–—æ¨¡æ‹Ÿå™¨
    </h1>
    
    <!-- è§’è‰²åˆ›å»ºåŒºåŸŸ -->
    <div id="character-creation" class="row">
        <div class="col-md-6">
            <h3><i class="fas fa-user-plus"></i> ç©å®¶1</h3>
            <div class="mb-3">
                <input type="text" id="player1-name" class="form-control" placeholder="è¾“å…¥è§’è‰²åå­—">
            </div>
            <div class="mb-3">
                <select id="player1-class" class="form-select">
                    <option value="">é€‰æ‹©èŒä¸š</option>
                    <option value="warrior">æˆ˜å£« (é«˜HPï¼Œä¸­ç­‰ä¼¤å®³)</option>
                    <option value="mage">æ³•å¸ˆ (ä½HPï¼Œé«˜ä¼¤å®³)</option>
                </select>
            </div>
            <button id="create-player1" class="btn btn-primary">
                <i class="fas fa-plus"></i> åˆ›å»ºè§’è‰²
            </button>
        </div>
        
        <div class="col-md-6">
            <h3><i class="fas fa-user-plus"></i> ç©å®¶2</h3>
            <div class="mb-3">
                <input type="text" id="player2-name" class="form-control" placeholder="è¾“å…¥è§’è‰²åå­—">
            </div>
            <div class="mb-3">
                <select id="player2-class" class="form-select">
                    <option value="">é€‰æ‹©èŒä¸š</option>
                    <option value="warrior">æˆ˜å£« (é«˜HPï¼Œä¸­ç­‰ä¼¤å®³)</option>
                    <option value="mage">æ³•å¸ˆ (ä½HPï¼Œé«˜ä¼¤å®³)</option>
                </select>
            </div>
            <button id="create-player2" class="btn btn-primary">
                <i class="fas fa-plus"></i> åˆ›å»ºè§’è‰²
            </button>
        </div>
    </div>
    
    <!-- è§’è‰²æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="characters-display" class="row" style="display: none;">
        <div class="col-md-6">
            <div id="player1-card" class="character-card">
                <h4 id="player1-name-display"></h4>
                <div class="hp-bar">
                    <div id="player1-hp" class="hp-fill" style="width: 100%;"></div>
                </div>
                <p id="player1-info"></p>
            </div>
        </div>
        <div class="col-md-6">
            <div id="player2-card" class="character-card">
                <h4 id="player2-name-display"></h4>
                <div class="hp-bar">
                    <div id="player2-hp" class="hp-fill" style="width: 100%;"></div>
                </div>
                <p id="player2-info"></p>
            </div>
        </div>
    </div>
    
    <!-- æˆ˜æ–—æ§åˆ¶åŒºåŸŸ -->
    <div id="battle-controls" class="text-center mt-4" style="display: none;">
        <button id="start-battle" class="btn btn-danger btn-lg">
            <i class="fas fa-fire"></i> å¼€å§‹æˆ˜æ–—ï¼
        </button>
        <button id="reset-game" class="btn btn-secondary btn-lg ms-3">
            <i class="fas fa-refresh"></i> é‡æ–°å¼€å§‹
        </button>
    </div>
    
    <!-- æˆ˜æ–—æ—¥å¿— -->
    <div id="battle-log" class="battle-log" style="display: none;">
        <h4><i class="fas fa-scroll"></i> æˆ˜æ–—æ—¥å¿—</h4>
        <div id="log-content"></div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸ -->
    <div id="game-over" class="text-center mt-4" style="display: none;">
        <div class="alert alert-success">
            <h2 id="winner-message"></h2>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let characters = {};
let battleRound = 0;

// åˆ›å»ºè§’è‰²
async function createCharacter(playerNum) {
    const name = document.getElementById(`player${playerNum}-name`).value;
    const charClass = document.getElementById(`player${playerNum}-class`).value;
    
    if (!name || !charClass) {
        alert('è¯·è¾“å…¥è§’è‰²åå­—å¹¶é€‰æ‹©èŒä¸šï¼');
        return;
    }
    
    try {
        const response = await fetch('/api/rpg/create_character', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                class: charClass
            })
        });
        
        const character = await response.json();
        characters[character.name] = character;
        
        // æ›´æ–°æ˜¾ç¤º
        updateCharacterDisplay(playerNum, character);
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹æˆ˜æ–—
        if (Object.keys(characters).length === 2) {
            document.getElementById('characters-display').style.display = 'block';
            document.getElementById('battle-controls').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('åˆ›å»ºè§’è‰²å¤±è´¥ï¼');
    }
}

// æ›´æ–°è§’è‰²æ˜¾ç¤º
function updateCharacterDisplay(playerNum, character) {
    const nameDisplay = document.getElementById(`player${playerNum}-name-display`);
    const hpBar = document.getElementById(`player${playerNum}-hp`);
    const info = document.getElementById(`player${playerNum}-info`);
    
    nameDisplay.textContent = `${character.name} (${character.character_class})`;
    const hpPercentage = (character.hp / character.max_hp) * 100;
    hpBar.style.width = `${hpPercentage}%`;
    
    if (hpPercentage < 30) {
        hpBar.classList.add('low');
    } else {
        hpBar.classList.remove('low');
    }
    
    info.innerHTML = `
        HP: ${character.hp}/${character.max_hp}<br>
        çŠ¶æ€: ${character.is_alive ? 'å­˜æ´»' : 'æ­»äº¡'}
    `;
}

// å¼€å§‹æˆ˜æ–—
async function startBattle() {
    const characterNames = Object.keys(characters);
    if (characterNames.length !== 2) {
        alert('éœ€è¦åˆ›å»ºä¸¤ä¸ªè§’è‰²æ‰èƒ½å¼€å§‹æˆ˜æ–—ï¼');
        return;
    }
    
    document.getElementById('battle-log').style.display = 'block';
    document.getElementById('start-battle').disabled = true;
    
    battleRound = 0;
    await battleLoop();
}

// æˆ˜æ–—å¾ªç¯
async function battleLoop() {
    const characterNames = Object.keys(characters);
    const player1 = characters[characterNames[0]];
    const player2 = characters[characterNames[1]];
    
    if (!player1.is_alive || !player2.is_alive) {
        endGame();
        return;
    }
    
    battleRound++;
    addToLog(`<strong>ç¬¬ ${battleRound} å›åˆ</strong>`);
    
    try {
        const response = await fetch('/api/rpg/battle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player1: characterNames[0],
                player2: characterNames[1]
            })
        });
        
        const result = await response.json();
        
        // æ›´æ–°è§’è‰²çŠ¶æ€
        characters[characterNames[0]] = result.player1;
        characters[characterNames[1]] = result.player2;
        
        // æ˜¾ç¤ºæˆ˜æ–—æ—¥å¿—
        result.battle_log.forEach(log => {
            addToLog(log);
        });
        
        // æ›´æ–°æ˜¾ç¤º
        updateCharacterDisplay(1, result.player1);
        updateCharacterDisplay(2, result.player2);
        
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        if (result.winner) {
            endGame(result.winner);
        } else {
            // ç»§ç»­ä¸‹ä¸€å›åˆ
            setTimeout(battleLoop, 1000);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('æˆ˜æ–—å¤±è´¥ï¼');
    }
}

// ç»“æŸæ¸¸æˆ
function endGame(winner = null) {
    if (winner) {
        document.getElementById('winner-message').textContent = `ğŸ† æˆ˜æ–—ç»“æŸï¼${winner} è·èƒœï¼`;
    } else {
        document.getElementById('winner-message').textContent = 'ğŸ† æˆ˜æ–—ç»“æŸï¼';
    }
    document.getElementById('game-over').style.display = 'block';
}

// é‡æ–°å¼€å§‹æ¸¸æˆ
function resetGame() {
    characters = {};
    battleRound = 0;
    
    // é‡ç½®è¡¨å•
    document.getElementById('player1-name').value = '';
    document.getElementById('player1-class').value = '';
    document.getElementById('player2-name').value = '';
    document.getElementById('player2-class').value = '';
    
    // éšè—å…ƒç´ 
    document.getElementById('characters-display').style.display = 'none';
    document.getElementById('battle-controls').style.display = 'none';
    document.getElementById('battle-log').style.display = 'none';
    document.getElementById('game-over').style.display = 'none';
    
    // é‡ç½®æŒ‰é’®
    document.getElementById('start-battle').disabled = false;
    
    // æ¸…ç©ºæ—¥å¿—
    document.getElementById('log-content').innerHTML = '';
}

// æ·»åŠ æ—¥å¿—
function addToLog(message) {
    const logContent = document.getElementById('log-content');
    logContent.innerHTML += `<div class="mb-2">${message}</div>`;
    logContent.scrollTop = logContent.scrollHeight;
}

// äº‹ä»¶ç›‘å¬å™¨
document.getElementById('create-player1').addEventListener('click', () => createCharacter(1));
document.getElementById('create-player2').addEventListener('click', () => createCharacter(2));
document.getElementById('start-battle').addEventListener('click', startBattle);
document.getElementById('reset-game').addEventListener('click', resetGame);
</script>
{% endblock %}

